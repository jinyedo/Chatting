<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chatting Room</title>
    <link rel="stylesheet" th:href="@{/css/room.css}">
</head>
<body>
    <div class="container">
        <h1>채팅방</h1>
        <div class="wrap_room">
            <table class="roomList"></table>
        </div>
        <div>
            <table class="inputTable">
                <tr>
                    <th>방제목</th>
                    <th><input type="text" name="roomName" class="roomName" /></th>
                    <th><button class="btn_createRoom" onclick="createRoom()">방 만들기</button></th>
                </tr>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script>

        window.onload = function () {
            getRoom();
        }

        // Ajax 로 방 목록 정보 불러오기 - 페이지 로드되면 바로 실행
        function getRoom() {
            commonAjax("/room/getRoomList", "", "post", null, function (result) {
                console.log(result);
                // 불러온 정보로 방 목록 생성
                gridChattingRoom(result);
            })
        }

        // 채팅방 생성
        function createRoom() {
            const roomName = {
                roomName: $(".roomName").val()
            };

            commonAjax("/room/createRoom", roomName, "post", null, function(result){
                alert("채팅방 생성이 완료되었습니다.");
                console.log(result);
                getRoom();
                goRoom(result.roomId, result.roomName);
            });

            $(".roomName").val("");
        }

        // 선택한 채팅방으로 이동
        function goRoom(roomId, roomName) {
            location.href = `/room/moveChatting?roomId=${roomId}&roomName=${roomName}`;
        }

        // 방 목록 뿌리기
        function gridChattingRoom(result) {
            if (result !== null) {
                // 헤더 생성
                let tag = `<tr>
                        <th class="num">방 번호</th>
                        <th class="room">방 이름</th>
                        <th class="go"></th>
                    </tr>`;

                // 방 개수만큼 row 생성
                result.forEach(function (data, idx) {
                    const roomId = data.roomId;
                    const roomName = data.roomName.trim();
                    tag += `<tr>
                            <td class="num">${idx + 1}</td>
                            <td class="room">${roomName}</td>
                            <td class="go"><button onclick='goRoom(\"${roomId}\", \"${roomName}\")'>참여</button></td>
                        </tr>`;
                });
                //$(".roomList").empty().append(tag);
                $(".roomList").html(tag);
            }
        }

        function commonAjax(url, param, type, contentType, callback) {
            $.ajax({
                url : url,
                data : JSON.stringify(param),
                type : type,
                contentType : contentType !== null ? contentType : "application/json; charset=UTF-8",
                success: function (res) {
                    callback(res)
                },
                err : function (err) {
                    console.log("error");
                    callback(err);
                }
            })
        }
    </script>
</body>
</html>